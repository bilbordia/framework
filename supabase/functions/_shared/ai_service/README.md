# AI Service Adapters

This directory contains the adapter modules responsible for abstracting interactions with various third-party AI model providers (e.g., OpenAI, Google, Anthropic). The primary goal of these adapters is to provide a consistent interface for listing available models and, where applicable, fetching model-specific details like token limits.

## Structure

Each AI provider should have its own adapter file (e.g., `openai_adapter.ts`, `google_adapter.ts`, `anthropic_adapter.ts`). Each adapter should implement a common interface (though not formally defined as a TypeScript `interface` in the current examples, they follow a similar pattern) that includes at least:

*   A `listModels(apiKey: string): Promise<ProviderModelInfo[]>` function.

The `ProviderModelInfo` type (defined in `supabase/functions/_shared/types.ts`) should be returned by `listModels` and includes:
*   `api_identifier`: The unique string ID the provider uses for the model.
*   `name`: A human-readable name for the model.
*   `description`: (Optional) A brief description.
*   `config`: (Optional) An object that can contain provider-specific pre-fetched configuration, such as `provider_max_input_tokens` and `provider_max_output_tokens`. The `sync-ai-models` function will merge this with its own default configurations.

## Configuration

### API Keys

Each adapter's `listModels` function requires an API key for the respective provider. These API keys are **not** stored in the codebase. They are expected to be securely passed to the `sync-ai-models` function, which then passes them to the appropriate adapter. The `sync-ai-models` function retrieves these keys from environment variables during its execution (e.g., `OPENAI_API_KEY`, `ANTHROPIC_API_KEY`, `GOOGLE_API_KEY`).

### Model Configuration (`AiModelExtendedConfig`)

While adapters can fetch some information (like `provider_max_input_tokens`), detailed configuration, especially **token costs (`input_token_cost_rate`, `output_token_cost_rate`)**, context window sizes, and tokenization strategies, are primarily managed by the `sync-ai-models` function (located in `supabase/functions/sync-ai-models/`).

The `sync-ai-models` function uses helper functions (e.g., `createDefaultOpenAIConfig`) to define default `AiModelExtendedConfig` (see `packages/types/src/ai.types.ts`) for each model. This configuration is then stored in the `config` JSONB column of the `ai_providers` table in the database.

**Manual Overrides:** If the default configurations generated by `sync-ai-models` are insufficient or need adjustment (especially for pricing, which can change frequently), the `config` column in the `ai_providers` table can be manually updated directly in the Supabase database. The sync process is designed to preserve manual overrides for most fields while updating API-provided details like `provider_max_input_tokens`.

## Adding a New Provider

1.  **Create an Adapter File:**
    *   Create a new file in this directory (e.g., `newprovider_adapter.ts`).
    *   Implement the `listModels(apiKey: string): Promise<ProviderModelInfo[]>` function. This function should:
        *   Call the new provider's API to list available models.
        *   Transform the provider's response into an array of `ProviderModelInfo` objects.
        *   Attempt to populate `provider_max_input_tokens` and `provider_max_output_tokens` in the `config` field of `ProviderModelInfo` if the provider's API returns this information.
2.  **Update `sync-ai-models`:**
    *   Go to `supabase/functions/sync-ai-models/index.ts`.
    *   Import your new adapter.
    *   Add a new sync function (e.g., `syncNewProviderModels`) similar to `syncOpenAIModels`, `syncAnthropicModels`, etc.
    *   In this new sync function, create a helper like `createDefaultNewProviderConfig(modelApiIdentifier: string): AiModelExtendedConfig` to define default costs, tokenization strategies, etc., for models from this provider.
    *   Add your new provider's sync function to the `PROVIDER_SYNC_FUNCTIONS` map in `sync-ai-models/index.ts`.
    *   Ensure the corresponding API key environment variable (e.g., `NEWPROVIDER_API_KEY`) is documented and set up in your Supabase project settings.

## Tokenization

Tokenization logic is not handled by these adapters directly. It is managed by utility functions (e.g., in `packages/utils/src/tokenCostUtils.ts`) based on the `tokenization_strategy` defined in the `AiModelExtendedConfig`. The adapters only provide the raw model information. 